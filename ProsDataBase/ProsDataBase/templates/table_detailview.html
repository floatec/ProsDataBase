{% extends "base.html" %}



{% block navigation %}
<div id="naviheader"></div>
 <ul id="navigationMenuContent">

 </ul>

{% endblock %}

{% block header %}
    <a class="crumb" href='#' id='tableCrumb'> <span>></span></a>
{% endblock %}
{% block menu %}
        <a class='buttonMenuButton' id='insertData' href='#'>Insert Data</a>
        <a class='buttonMenuButton' id='deleteData' href='#'>Delete Data</a>
        <a class='buttonMenuButton'>Export</a>
        <a class='buttonMenuButton' id='modifyStructure'>Modify Structure</a>
{% endblock %}

{% block content %}
        <div id="deleteAlertBox">Are you sure to delete this item(s)?</div>
   <table id='detailTable' class='datasets' border='1'><thead id='descrRow'></thead></table>

{% endblock %}
{% block javascript %}
<script language="JavaScript">


init();




function init(){

    var tableName = getTableName();
    $("#naviheader").append(tableName)
     columns = [];
    $.getJSON('/api/table/'+tableName+'/structure/',function(data){
         columns = data.columns;
         createTable(columns);
    });
    $("#tableCrumb").prepend(tableName);
    $("#tableCrumb").attr('href', '/detailview/'+tableName+'/');
    $("#insertData").attr('href', '/dataset/'+tableName+'/');
    $("#modifyStructure").attr('href','/modify/'+tableName+'/');
    $("#deleteData").click(function(){



    });
}
function createTable(columns){
    var tableName = getTableName();
    var columns = columns;
    $("#detailTable").prepend("<caption>"+tableName+"</capton>");
    //$("#navigationMenuContent").append("<li><a href='#'><span class=\"ui-icon ui-icon-plusthick\"></span>back</a></li>");
     $("#descrRow").append("<th>select</th><th>data edit</th><th>system ID</th>");
    for(var key in columns){
        $("#descrRow").append("<th>"+columns[key].name+"</th>");
        $("#navigationMenuContent").append("<li><a href='#"+columns[key].name+"'>"+columns[key].name+"</a></li>");


    }

createDatasets();

}

function getTableName(){
    var tableName = window.location.href;
    var lastIndex = tableName.lastIndexOf('/');
    var tableName = tableName.substr(0,lastIndex);
    var lastIndex = tableName.lastIndexOf('/');
    var tableName = tableName.substr(lastIndex+1);
    return tableName;
}

function createDatasets(){

    var tableName = getTableName();
    $.getJSON('/api/table/'+tableName+'/',function(data){
         allDatasets = data.datasets;
        console.log(data);

         var counter = 0;
        for(var key in allDatasets){


          $("#detailTable").append("<tr class='contentRow' id='datasetRow"+counter+"'><td><input type='checkbox' class='selectDataset'></td><td><a href='/modifyDataset/"+tableName+"/"+allDatasets[key].id+"'>edit</a></td><td class='datasetClassCell'>"+allDatasets[key].id+"</td></tr>");

            for(var p in columns){
          for(var i in allDatasets[key].data){
              if(allDatasets[key].data[i].column == columns[p].name){

              $("#datasetRow"+counter).append("<td>"+allDatasets[key].data[i].value+"</td>")
              }

          }

            }
          counter++;

        }

    });


}




function deleteDataSet(){

    var datasetIDs = [];
    $(".contentRow").each(function(){

      if($(this).find(".selectDataset").is(':checked')){
             $(this).remove();
            datasetIDs.push($(this).find(".datasetClassCell").text());

        }

    });

        $.ajax({
        url: '/api/table/'+getTableName()+'/dataset/',
        type: 'delete',
        data: JSON.stringify(datasetIDs),
        contentType: 'application/json',
        dataType: 'json'
    });



}

    $("#deleteData").click(function(){
         $("#deleteAlertBox").dialog("open");


    });

  // initialize alertbox
    $("#deleteAlertBox").dialog({
        autoOpen: false,
        buttons: {
            "delete": function () {
                deleteDataSet();
                $(this).dialog("close");
            },
            "back": function () {
                $(this).dialog("close");
            }
        }
    });

</script>
{% endblock %}